# Generated by Chef
Start-Transcript "$($env:TEMP)\mysql.derp_install.log"

# Function definitions
configuration SQLInstanceInstallationConfiguration {
    Import-DscResource -Module xMySql

    node $AllNodes.NodeName {
        Package mysql_bits {                    
            Path = "<%= @package_uri %>"
            ProductId = $Node.PackageProductID 
            Name = "MySQL Install"
        }
        
        xMySqlServer MySQLInstance {
            Ensure = "Present"
            RootPassword = $global:cred
            ServiceName = "<%= @mysql_name %>"
            DependsOn = "[Package]mysql_bits"
        }
    }
}

# variables
$global:pwd = ConvertTo-SecureString "<%= @initial_root_password %>" -AsPlainText -Force
$global:usrName = "root"
$global:cred = New-Object -TypeName System.Management.Automation.PSCredential ($global:usrName,$global:pwd)

# Mof compilation
cd <%= @work_dir %>
SQLInstanceInstallationConfiguration -ConfigurationData @{
    # Node specific data
    AllNodes = @(    
        # Data  for all the nodes that will be created by the full production scenario.
            @{
            NodeName          = "<%= @node_name %>"           
            PSDscAllowPlainTextPassword = "<%= @ps_dsc_allow_plain_text_password %>";
            PackageProductID = "<%= @package_product_id %>"
                              
            };        
    );
}

Start-DscConfiguration -Wait -Verbose -Path .\SQLInstanceInstallationConfiguration
Stop-Transcript
